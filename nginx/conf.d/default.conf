fastcgi_cache_path /etc/nginx/cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";

# Rate Limiting
# limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

# Bloqueio de Bad Bots
# map $http_user_agent $bad_bot {
#     default 0;
#     ~*(dirbuster|nikto|wpscan|sqlmap|python-requests|curl|wget) 1;
# }

server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.php index.html;

    # Bloqueio de Bad Bots
    # if ($bad_bot) {
    #     return 403;
    # }

    # Debug do Cache
    add_header X-Cache-Status $upstream_cache_status;

    # Security Headers
    # add_header X-Frame-Options "SAMEORIGIN" always;
    # add_header X-XSS-Protection "1; mode=block" always;
    # add_header X-Content-Type-Options "nosniff" always;
    # add_header Referrer-Policy "no-referrer-when-downgrade" always;
    # CSP Estável: Permite a mesma origem (incluindo o proxy das mídias)
    # add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline' 'unsafe-eval'; img-src 'self' * data: blob:; font-src 'self' * data:; connect-src 'self' *; frame-src *;" always;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

    # Tamanho máximo de upload
    client_max_body_size 64M;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        # FastCGI Cache
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_use_stale error timeout updating invalid_header http_500 http_503;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;

        # Timeouts para uploads grandes
        fastcgi_read_timeout 300;
    }

    # Lógica para Pular Cache (Usuários Logados, etc)
    set $skip_cache 0;
    if ($request_method = POST) { set $skip_cache 1; }
    if ($query_string != "") { set $skip_cache 1; }
    if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") { set $skip_cache 1; }
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-7]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") { set $skip_cache 1; }

    # Proteção de arquivos sensíveis e XML-RPC
    # location ~* /(?:uploads|files)/.*\.php$ {
    #     deny all;
    # }

    # location ~* \.(ht|git|ini|conf)$ {
    #     deny all;
    # }

    # location = /xmlrpc.php {
    #     deny all;
    #     access_log off;
    #     log_not_found off;
    # }

    # location ~* wp-config.php {
    #     deny all;
    # }

    # location ~* wp-admin/includes/ {
    #     deny all;
    # }

    # Rate Limit para Login
    location = /wp-login.php {
        # limit_req zone=login burst=5 nodelay;
        fastcgi_pass wordpress:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Proxy para MinIO (Resolve problemas de porta e Cross-Origin)
    location ^~ /media-wp/ {
        proxy_pass http://minio:9000/media-wp/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
        expires max;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        log_not_found off;
        access_log off;
        allow all;
    }

    # Cache de arquivos estáticos
    location ~* \.(css|gif|ico|jpeg|jpg|js|png|svg|webp|woff|woff2|ttf|otf)$ {
        expires max;
        log_not_found off;
        access_log off;
    }
}
